# 要件定義書

## はじめに

本文書は、Zendeskチケット履歴アプリケーションの要件を定義します。このアプリケーションは、Zendesk Apps Framework (ZAF) を使用したフロントエンドと、AWS Lambda + API Gateway + Amazon Bedrock を使用したバックエンドで構成され、チケット依頼者の過去のチケット履歴を表示し、AIによる要約を提供します。

## 用語集

- **ZAF (Zendesk Apps Framework)**: Zendeskアプリケーションを開発するためのフレームワーク
- **依頼者 (Requester)**: チケットを作成したユーザー
- **チケット履歴 (Ticket History)**: 特定の依頼者が過去に作成したチケットの一覧
- **AI要約 (AI Summary)**: Amazon Bedrockを使用して生成されたチケット履歴の要約
- **Bedrock**: AWSが提供する生成AIサービス
- **Lambda関数 (Lambda Function)**: AWSのサーバーレスコンピューティングサービス
- **API Gateway**: AWSのAPIマネジメントサービス
- **キャッシュ (Cache)**: 一時的にデータを保存する仕組み

## 要件

### 要件1: 依頼者情報の取得

**ユーザーストーリー:** サポート担当者として、現在のチケットの依頼者情報を取得したい。これにより、その依頼者の過去のチケット履歴を検索できるようにする。

#### 受入基準

1. WHEN サポート担当者がチケットを開いたとき、THE システム SHALL ZAF APIを使用して依頼者のメールアドレスを取得する
2. IF 依頼者情報が存在しない場合、THEN THE システム SHALL エラーメッセージを表示する
3. WHEN 依頼者情報を取得したとき、THE システム SHALL メールアドレスを抽出して保持する

### 要件2: 過去チケット履歴の取得

**ユーザーストーリー:** サポート担当者として、依頼者の過去のチケット履歴を確認したい。これにより、過去の問い合わせ内容を把握し、より適切な対応ができるようにする。

#### 受入基準

1. WHEN 依頼者のメールアドレスが取得されたとき、THE システム SHALL Zendesk Search APIを使用して同じメールアドレスのチケットを検索する
2. WHEN チケット履歴を取得したとき、THE システム SHALL チケットを作成日時の降順でソートする
3. WHEN チケット履歴を表示するとき、THE システム SHALL 各チケットの件名、作成日時、ステータスを表示する
4. WHEN チケットの件名を表示するとき、THE システム SHALL 件名を最大100文字に制限する
5. WHEN チケット履歴を取得したとき、THE システム SHALL 現在開いているチケットを結果から除外する

### 要件3: チケット情報の表示形式

**ユーザーストーリー:** サポート担当者として、チケット履歴を見やすい形式で確認したい。これにより、情報を素早く理解できるようにする。

#### 受入基準

1. IF 過去のチケットが存在しない場合、THEN THE システム SHALL 「過去のチケットはありません」というメッセージを表示する
2. WHEN チケットの作成日時を表示するとき、THE システム SHALL 「YYYY-MM-DD HH:MM」形式で表示する
3. WHEN チケットのステータスを表示するとき、THE システム SHALL 日本語で表示する（new→新規、open→対応中、solved→解決済み、closed→クローズ）

### 要件4: AI要約機能のUI

**ユーザーストーリー:** サポート担当者として、過去のチケット履歴をAIで要約したい。これにより、大量のチケット履歴を短時間で把握できるようにする。

#### 受入基準

1. WHEN 過去のチケットが存在するとき、THE システム SHALL 「要約する」ボタンを表示する
2. WHEN サポート担当者が「要約する」ボタンをクリックしたとき、THE システム SHALL AI要約生成処理を開始する
3. WHILE AI要約を生成中、THE システム SHALL ローディングインジケーターを表示する
4. IF 過去のチケットが存在しない場合、THEN THE システム SHALL 「要約する」ボタンを無効化する

### 要件5: AI要約生成処理

**ユーザーストーリー:** システムとして、過去のチケット履歴から有用な要約を生成したい。これにより、サポート担当者が効率的に対応できるようにする。

#### 受入基準

1. WHEN AI要約生成が要求されたとき、THE システム SHALL AWS Lambda関数を呼び出す
2. WHEN Lambda関数がBedrockにリクエストを送信するとき、THE システム SHALL チケット情報を含むプロンプトを構築する
3. WHEN プロンプトを構築するとき、THE システム SHALL 「過去の問い合わせ履歴の要約」「注意点」「対応のヒント」の生成を指示する
4. WHEN Bedrockから応答を受信したとき、THE システム SHALL 要約結果をフロントエンドに返却する
5. IF Bedrock APIがエラーを返した場合、THEN THE システム SHALL エラーメッセージをフロントエンドに返却する

### 要件6: AI要約結果の表示

**ユーザーストーリー:** サポート担当者として、AI要約結果を読みやすい形式で確認したい。これにより、要約内容を素早く理解できるようにする。

#### 受入基準

1. WHEN AI要約が生成されたとき、THE システム SHALL 要約結果を専用エリアに表示する
2. WHEN 要約結果が長い場合、THE システム SHALL スクロール可能な表示エリアを提供する
3. WHEN 要約結果を表示したとき、THE システム SHALL ローディングインジケーターを非表示にする
4. WHEN 要約結果を表示したとき、THE システム SHALL ボタンテキストを「再要約する」に変更する

### 要件7: エラーハンドリング

**ユーザーストーリー:** サポート担当者として、エラーが発生した場合に適切なメッセージを確認したい。これにより、問題を理解し、適切に対処できるようにする。

#### 受入基準

1. IF Zendesk APIがエラーを返した場合、THEN THE システム SHALL エラーメッセージを表示する
2. IF Bedrock APIがエラーを返した場合、THEN THE システム SHALL エラーメッセージを表示する
3. IF ネットワークタイムアウトが発生した場合、THEN THE システム SHALL エラーメッセージを表示する
4. WHEN エラーメッセージを表示するとき、THE システム SHALL メッセージを赤色で表示する
5. WHEN エラーが発生したとき、THE システム SHALL エラー詳細をコンソールログに出力する

### 要件8: パフォーマンス最適化

**ユーザーストーリー:** システムとして、API呼び出しを最小限に抑えたい。これにより、レスポンス時間を短縮し、コストを削減する。

#### 受入基準

1. THE システム SHALL チケット情報をメモリ内にキャッシュする
2. THE システム SHALL 同一メールアドレスの2回目以降の呼び出しでキャッシュを使用する
3. WHEN 同一メールアドレスのチケット履歴が要求されたとき、THE システム SHALL Zendesk APIを再度呼び出さずにキャッシュから取得する
4. WHEN キャッシュからチケット履歴を取得したとき、THE システム SHALL API呼び出しを行わない

### 要件9: セキュリティとプライバシー

**ユーザーストーリー:** システム管理者として、顧客情報を適切に保護したい。これにより、プライバシーとセキュリティを確保する。

#### 受入基準

1. THE システム SHALL API Keyを使用してバックエンドAPIへのアクセスを認証する
2. THE システム SHALL API Key認証を使用してLambda関数へのアクセスを制限する
3. THE システム SHALL 顧客情報をローカルストレージに保存しない
4. THE システム SHALL Zendeskドメインからのアクセスのみを許可するCORS設定を行う
5. WHEN セッションが終了したとき、THE システム SHALL キャッシュをクリアする

### 要件10: デプロイメントと運用

**ユーザーストーリー:** システム管理者として、アプリケーションを適切にデプロイし、運用したい。これにより、安定したサービスを提供する。

#### 受入基準

1. THE システム SHALL Zendesk Apps Frameworkの要件に準拠したmanifest.jsonを提供する
2. THE システム SHALL Lambda関数に適切なIAMロールと権限を設定する
3. THE システム SHALL 環境変数を使用してBedrock設定を管理する（BEDROCK_REGION, BEDROCK_MODEL_ID）
4. THE システム SHALL すべてのAPI呼び出しをCloudWatch Logsに記録する
5. THE システム SHALL zcliを使用してZendesk Appをパッケージ化できる
