# 実装計画: Zendeskチケット履歴アプリ

## 概要

本実装計画は、Zendesk Apps Framework (ZAF) を使用したフロントエンドアプリケーションと、AWS Lambda + API Gateway を使用したバックエンドサービスの構築を段階的に進めます。各タスクは前のタスクの成果物を基に構築され、最終的にすべてのコンポーネントを統合します。

## タスク

- [x] 1. プロジェクト構造とZendesk Appの基本セットアップ
  - Zendesk Appのディレクトリ構造を作成
  - manifest.jsonを作成し、アプリのメタデータと権限を定義
  - 基本的なHTML/CSS/JavaScriptファイルを作成
  - ZAF Clientの初期化コードを実装
  - _要件: 10.1, 10.2_

- [x] 2. 依頼者メールアドレスの取得機能
  - [x] 2.1 ZAF APIを使用してチケット情報を取得する関数を実装
    - `getRequesterEmail()` 関数を実装
    - ZAF Client APIを使用してチケットの依頼者情報を取得
    - メールアドレスを抽出して返す
    - _要件: 1.1, 1.3_
  
  - [ ]* 2.2 メールアドレス取得のプロパティテストを作成
    - **プロパティ1: メールアドレスの取得と保持**
    - **検証: 要件 1.1, 1.3**
  
  - [ ]* 2.3 メールアドレスが存在しない場合のエラーハンドリングをテスト
    - 依頼者情報が存在しない場合のエラー表示を検証
    - _要件: 1.2_

- [x] 3. Zendesk APIを使用した過去チケット取得機能
  - [x] 3.1 チケット検索機能を実装
    - `fetchTicketHistory(email)` 関数を実装
    - Zendesk Search APIを使用して同じメールアドレスのチケットを検索
    - 現在のチケットを結果から除外
    - _要件: 2.1, 2.5_
  
  - [x] 3.2 チケットのソート機能を実装
    - 取得したチケットを作成日時の降順でソート
    - _要件: 2.2_
  
  - [ ]* 3.3 チケット検索APIのプロパティテストを作成
    - **プロパティ2: チケット検索APIの呼び出し**
    - **検証: 要件 2.1**
  
  - [ ]* 3.4 チケットソートのプロパティテストを作成
    - **プロパティ3: チケットの降順ソート**
    - **検証: 要件 2.2**
  
  - [ ]* 3.5 現在のチケット除外のプロパティテストを作成
    - **プロパティ5: 現在のチケットの除外**
    - **検証: 要件 2.5**

- [x] 4. チケット一覧の表示機能
  - [x] 4.1 チケット一覧のレンダリング関数を実装
    - `renderTicketList(tickets)` 関数を実装
    - 各チケットの件名（最大100文字）、作成日時（YYYY-MM-DD HH:MM形式）、ステータス（日本語）を表示
    - 過去のチケットが存在しない場合のメッセージ表示
    - _要件: 2.3, 2.4, 3.1, 3.2, 3.3_
  
  - [x] 4.2 日時フォーマット関数を実装
    - ISO 8601形式の日時を「YYYY-MM-DD HH:MM」形式に変換
    - _要件: 3.2_
  
  - [x] 4.3 ステータス日本語変換関数を実装
    - Zendeskのステータス値を日本語に変換（new→新規、open→対応中、solved→解決済み、closed→クローズ）
    - _要件: 3.3_
  
  - [ ]* 4.4 チケット表示内容のプロパティテストを作成
    - **プロパティ4: チケット表示内容の完全性**
    - **検証: 要件 2.3, 3.1, 3.2, 3.3**

- [x] 5. チェックポイント - 基本機能の動作確認
  - すべてのテストが成功することを確認
  - チケット一覧の表示が正しく動作することを確認
  - 質問があればユーザーに確認

- [x] 6. AWS Lambda関数の実装
  - [x] 6.1 Lambda関数のプロジェクト構造を作成
    - Node.js 18.xプロジェクトを初期化
    - 必要な依存関係をインストール（@aws-sdk/client-bedrock-runtime）
    - _要件: 5.1_
  
  - [x] 6.2 Bedrockプロンプト構築関数を実装
    - `buildPrompt(tickets)` 関数を実装
    - チケット情報から要約生成用のプロンプトを構築
    - プロンプトに「過去の問い合わせ履歴の要約」「注意点」「対応のヒント」の生成指示を含める
    - _要件: 5.2, 5.3_
  
  - [x] 6.3 Bedrock API呼び出し関数を実装
    - `invokeBedrock(prompt)` 関数を実装
    - BedrockRuntimeClientを使用してClaude 3 Haikuモデルを呼び出し
    - _要件: 5.1_
  
  - [x] 6.4 Lambda handlerを実装
    - リクエストボディの解析
    - プロンプト構築とBedrock呼び出しの統合
    - レスポンスの返却
    - エラーハンドリング
    - _要件: 5.1, 5.4, 5.5_
  
  - [x] 6.5 Bedrockリクエスト構築のプロパティテストを作成
    - **プロパティ6: Bedrock APIリクエストの構築**
    - **検証: 要件 5.2, 5.3**
  
  - [ ]* 6.6 Lambda関数のユニットテストを作成
    - 空のチケット配列の処理をテスト
    - 不正なリクエスト形式の処理をテスト
    - Bedrock APIエラーのハンドリングをテスト
    - _要件: 5.5, 7.2_

- [x] 7. API Gatewayの設定
  - [x] 7.1 API Gateway REST APIを作成
    - `/summarize` エンドポイントを定義
    - POSTメソッドを設定
    - Lambda関数との統合を設定
    - _要件: 5.1_
  
  - [x] 7.2 API Key認証を設定
    - API Keyを作成
    - 使用量プランを設定
    - _要件: 9.2_
  
  - [x] 7.3 CORS設定を追加
    - Zendeskドメインからのアクセスを許可
    - 適切なHTTPヘッダーを設定
    - _要件: 9.4_

- [x] 8. フロントエンドのAI要約機能実装
  - [x] 8.1 「要約する」ボタンのUI実装
    - ボタン要素を追加
    - ボタンのクリックイベントハンドラーを実装
    - チケットが存在しない場合はボタンを無効化
    - _要件: 4.1, 4.2, 4.4_
  
  - [x] 8.2 AI要約生成関数を実装
    - `generateSummary(tickets)` 関数を実装
    - API Gatewayエンドポイントへのリクエストを送信
    - ローディングインジケーターの表示/非表示
    - _要件: 4.2, 4.3, 5.1_
  
  - [x] 8.3 要約結果の表示機能を実装
    - 要約結果を専用エリアに表示
    - スクロール可能な表示エリアを実装
    - ボタンテキストを「再要約する」に変更
    - _要件: 5.4, 6.1, 6.3, 6.4_
  
  - [ ]* 8.4 AI要約表示のプロパティテストを作成
    - **プロパティ7: AI要約の表示**
    - **検証: 要件 5.4, 6.1**
  
  - [ ]* 8.5 AI要約機能のユニットテストを作成
    - ボタン表示のテスト
    - ローディングインジケーター表示のテスト
    - Bedrock APIエラー時の処理をテスト
    - 要約表示エリアのスクロール設定をテスト
    - ボタンテキスト変更のテスト
    - _要件: 4.1, 4.3, 5.5, 6.3, 6.4_

- [x] 9. エラーハンドリングの実装
  - [x] 9.1 エラー表示関数を実装
    - `showError(message, details)` 関数を実装
    - エラーメッセージを赤色で表示
    - エラー詳細をコンソールログに出力
    - _要件: 7.4, 7.5_
  
  - [x] 9.2 各種エラーケースのハンドリングを追加
    - Zendesk APIエラーのハンドリング
    - Bedrock APIエラーのハンドリング
    - ネットワークタイムアウトのハンドリング
    - _要件: 7.1, 7.2, 7.3_
  
  - [ ]* 9.3 エラーログのプロパティテストを作成
    - **プロパティ8: エラーログの出力**
    - **検証: 要件 7.5**
  
  - [ ]* 9.4 エラーハンドリングのユニットテストを作成
    - 各種エラーメッセージの表示をテスト
    - エラーメッセージの色をテスト
    - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 10. キャッシング機能の実装
  - [x] 10.1 チケット情報のキャッシュ機能を実装
    - メモリ内キャッシュを実装
    - 同一メールアドレスの2回目以降の呼び出しでキャッシュを使用
    - _要件: 8.3, 8.4_
  
  - [x] 10.2 セッション終了時のキャッシュクリア機能を実装
    - セッション終了イベントをリッスン
    - キャッシュをクリア
    - _要件: 9.5_
  
  - [ ]* 10.3 キャッシングのプロパティテストを作成
    - **プロパティ9: チケット情報のキャッシング**
    - **検証: 要件 8.3, 8.4**
  
  - [ ]* 10.4 キャッシングのユニットテストを作成
    - セッション終了時のキャッシュクリアをテスト
    - _要件: 9.5_

- [x] 11. ロギング機能の実装
  - [x] 11.1 Lambda関数にアクセスログを追加
    - すべてのAPI呼び出しをログに記録
    - タイムスタンプ、エンドポイント、ステータスを含める
    - _要件: 10.4_
  
  - [ ]* 11.2 アクセスログのプロパティテストを作成
    - **プロパティ10: アクセスログの記録**
    - **検証: 要件 10.4**

- [x] 12. セキュリティとプライバシーの実装
  - [x] 12.1 ローカルストレージへの非保存を確認
    - 顧客情報がローカルストレージに保存されないことを確認
    - _要件: 9.3_
  
  - [ ]* 12.2 セキュリティのユニットテストを作成
    - ローカルストレージへの非保存をテスト
    - _要件: 9.3_

- [x] 13. チェックポイント - すべての機能の統合確認
  - すべてのテストが成功することを確認
  - フロントエンドとバックエンドの統合が正しく動作することを確認
  - 質問があればユーザーに確認

- [-] 14. デプロイメント準備
  - [ ] 14.1 Zendesk Appのパッケージング
    - zcli を使用してアプリをパッケージ化
    - manifest.jsonのバージョンを確認
    - _要件: 10.3, 10.5_
  
  - [x] 14.2 Lambda関数のデプロイ設定
    - 環境変数を設定（BEDROCK_REGION, BEDROCK_MODEL_ID）
    - IAMロールと権限を設定
    - _要件: 10.2, 10.3_
  
  - [ ] 14.3 CloudWatch監視の設定
    - ログの集約設定
    - メトリクスの設定（API呼び出し回数、エラー率、レイテンシ）
    - アラートの設定
    - _要件: 10.4_

- [x] 15. 最終チェックポイント - デプロイ前の確認
  - すべてのテストが成功することを確認
  - 設定ファイルが正しく設定されていることを確認
  - デプロイメント手順を確認
  - 質問があればユーザーに確認

## 注意事項

- `*` マークが付いているタスクはオプションであり、より迅速なMVP開発のためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントタスクで段階的な検証を行います
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
